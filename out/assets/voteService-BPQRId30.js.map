{"version":3,"file":"voteService-BPQRId30.js","sources":["../../src/services/chatService.ts","../../src/services/voteService.ts"],"sourcesContent":["/**\n * 그룹 채팅. GET/POST /api/groups/:groupId/chat/messages\n * - Authorization 헤더 필수. 로그인 안 되면 401, 해당 그룹(매칭방) 멤버가 아니면 403.\n * @see docs/API_SPEC.md §7\n */\nimport type { ChatMessageItem } from \"../types\";\nimport { apiGet, apiPost, getAuthToken, type ApiError } from \"./apiClient\";\n\nconst getWsBaseUrl = (): string => {\n  const url = import.meta.env.VITE_API_BASE_URL;\n  const base = url ? url.replace(/\\/$/, \"\") : \"http://localhost:8080\";\n  return base.replace(/^http/, \"ws\");\n};\n\n/** WebSocket 채팅 연결 URL. token 쿼리 필수 — 서버에서 검증·멤버 여부 확인 후 비멤버는 POLICY_VIOLATION으로 종료 */\nexport function getChatWebSocketUrl(groupId: number): string | null {\n  const token = getAuthToken()?.trim();\n  if (!token) return null;\n  const base = getWsBaseUrl();\n  return `${base}/groups/${groupId}/chat?token=${encodeURIComponent(token)}`;\n}\n\nconst FORBIDDEN_MESSAGE =\n  \"이 그룹의 멤버가 아닙니다. 해당 채팅방에 참가한 멤버만 읽고 쓸 수 있습니다.\";\n\n/** GET 응답: { roomId, messages }. groupId 없거나 API 실패 시 빈 배열. 403 시 throw */\nexport async function getChatMessages(\n  groupId?: number\n): Promise<ChatMessageItem[]> {\n  if (groupId == null) return [];\n  try {\n    const body = await apiGet<\n      { roomId: number; messages: ChatMessageItem[] } | ChatMessageItem[]\n    >(`/api/groups/${groupId}/chat/messages`);\n    if (Array.isArray(body)) return body;\n    return body.messages ?? [];\n  } catch (e) {\n    const err = e as ApiError;\n    if (err.status === 403) throw new Error(err.message || FORBIDDEN_MESSAGE);\n    return [];\n  }\n}\n\n/** 메시지 전송. POST /api/groups/:groupId/chat/messages (로그인 필수, 멤버 아니면 403) */\nexport async function sendChatMessage(\n  groupId: number,\n  message: string\n): Promise<{ success: boolean; messageId?: number; message?: string }> {\n  try {\n    const res = await apiPost<{ success: boolean; messageId?: number }>(\n      `/api/groups/${groupId}/chat/messages`,\n      { message }\n    );\n    return res;\n  } catch (e) {\n    const err = e as ApiError;\n    const messageText =\n      err.status === 403\n        ? err.message || FORBIDDEN_MESSAGE\n        : err.message ?? \"메시지 전송에 실패했습니다.\";\n    return { success: false, message: messageText };\n  }\n}\n\n/** 투자계획 공유 메시지 전송 (채팅에 trade 카드 + 투표 생성은 별도 createVote 호출) */\nexport async function sendTradeMessage(\n  groupId: number,\n  tradeData: {\n    action: \"매수\" | \"매도\";\n    stockName: string;\n    quantity: number;\n    pricePerShare: number;\n    totalAmount: number;\n    reason: string;\n    tags: string[];\n  }\n): Promise<{ success: boolean; messageId?: number; message?: string }> {\n  try {\n    const res = await apiPost<{ success: boolean; messageId?: number }>(\n      `/api/groups/${groupId}/chat/messages`,\n      { type: \"trade\", tradeData }\n    );\n    return res;\n  } catch (e) {\n    const err = e as ApiError;\n    const messageText =\n      err.status === 403\n        ? err.message || FORBIDDEN_MESSAGE\n        : err.message ?? \"공유에 실패했습니다.\";\n    return { success: false, message: messageText };\n  }\n}\n","/**\n * 그룹 투표 목록. GET /api/groups/:groupId/votes\n * 투표 생성. POST /api/groups/:groupId/votes\n * @see docs/API_SPEC.md §8\n */\nimport type { VoteItem } from \"../types\";\nimport { apiGet, apiPost } from \"./apiClient\";\n\nexport async function getVotes(groupId?: number): Promise<VoteItem[]> {\n  if (groupId == null) return [];\n  return await apiGet<VoteItem[]>(`/api/groups/${groupId}/votes`);\n}\n\nexport interface CreateVotePayload {\n  type: \"매수\" | \"매도\";\n  stockName: string;\n  stockCode?: string;\n  quantity: number;\n  proposedPrice: number;\n  reason: string;\n}\n\nexport async function createVote(\n  groupId: number,\n  payload: CreateVotePayload\n): Promise<{ success: boolean; voteId?: number; message?: string }> {\n  const res = await apiPost<{ success: boolean; voteId?: number; message?: string }>(\n    `/api/groups/${groupId}/votes`,\n    payload\n  );\n  return res;\n}\n\n/** 투표 제출 (찬성/반대/보류). POST /api/groups/:groupId/votes/:voteId */\nexport async function submitVote(\n  groupId: number,\n  voteId: number,\n  vote: \"찬성\" | \"반대\" | \"보류\"\n): Promise<{ success: boolean; message?: string }> {\n  const res = await apiPost<{ success: boolean; message?: string }>(\n    `/api/groups/${groupId}/votes/${voteId}`,\n    { vote }\n  );\n  return res;\n}\n"],"names":["FORBIDDEN_MESSAGE","getChatMessages","groupId","body","apiGet","err","sendChatMessage","message","apiPost","e","sendTradeMessage","tradeData","getVotes","createVote","payload"],"mappings":"+CAsBA,MAAMA,EACJ,+CAGF,eAAsBC,EACpBC,EAC4B,CAC5B,GAAIA,GAAW,KAAM,MAAO,CAAA,EAC5B,GAAI,CACF,MAAMC,EAAO,MAAMC,EAEjB,eAAeF,CAAO,gBAAgB,EACxC,OAAI,MAAM,QAAQC,CAAI,EAAUA,EACzBA,EAAK,UAAY,CAAA,CAC1B,OAAS,EAAG,CACV,MAAME,EAAM,EACZ,GAAIA,EAAI,SAAW,IAAK,MAAM,IAAI,MAAMA,EAAI,SAAWL,CAAiB,EACxE,MAAO,CAAA,CACT,CACF,CAGA,eAAsBM,EACpBJ,EACAK,EACqE,CACrE,GAAI,CAKF,OAJY,MAAMC,EAChB,eAAeN,CAAO,iBACtB,CAAE,QAAAK,CAAA,CAAQ,CAGd,OAASE,EAAG,CACV,MAAMJ,EAAMI,EAKZ,MAAO,CAAE,QAAS,GAAO,QAHvBJ,EAAI,SAAW,IACXA,EAAI,SAAWL,EACfK,EAAI,SAAW,iBACa,CACpC,CACF,CAGA,eAAsBK,EACpBR,EACAS,EASqE,CACrE,GAAI,CAKF,OAJY,MAAMH,EAChB,eAAeN,CAAO,iBACtB,CAAE,KAAM,QAAS,UAAAS,CAAA,CAAU,CAG/B,OAASF,EAAG,CACV,MAAMJ,EAAMI,EAKZ,MAAO,CAAE,QAAS,GAAO,QAHvBJ,EAAI,SAAW,IACXA,EAAI,SAAWL,EACfK,EAAI,SAAW,aACa,CACpC,CACF,CCnFA,eAAsBO,EAASV,EAAuC,CACpE,OAAIA,GAAW,KAAa,CAAA,EACrB,MAAME,EAAmB,eAAeF,CAAO,QAAQ,CAChE,CAWA,eAAsBW,EACpBX,EACAY,EACkE,CAKlE,OAJY,MAAMN,EAChB,eAAeN,CAAO,SACtBY,CAAA,CAGJ"}